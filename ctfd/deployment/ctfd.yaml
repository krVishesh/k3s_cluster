# CTFd Deployment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ctfd-main
  namespace: ctfd
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: ctfd-main
  template:
    metadata:
      labels:
        app: ctfd-main
    spec:
      securityContext:
        runAsUser: 0
      containers:
        - name: ctfd-main
          image: ctfd/ctfd:latest
          ports:
            - containerPort: 8000
          env:
            - name: UPLOAD_FOLDER
              value: "/var/uploads"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: ctfd-secret
                  key: DATABASE_URL
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: ctfd-secret
                  key: REDIS_URL
            - name: WORKERS
              value: "1"
            - name: LOG_FOLDER
              value: "/var/log/CTFd"
            - name: ACCESS_LOG
              value: "-"
            - name: ERROR_LOG
              value: "-"
            - name: REVERSE_PROXY
              value: "true"
            - name: PRESET_ADMIN_NAME
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: PRESET_ADMIN_NAME
            - name: PRESET_ADMIN_EMAIL
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: PRESET_ADMIN_EMAIL
            - name: PRESET_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: PRESET_ADMIN_PASSWORD
            - name: MAILFROM_ADDR
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAILFROM_ADDR
            - name: MAIL_SERVER
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_SERVER
            - name: MAIL_PORT
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_PORT
            - name: MAIL_USEAUTH
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_USEAUTH
            - name: MAIL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_USERNAME
            - name: MAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_PASSWORD
            - name: MAIL_TLS
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_TLS
            - name: MAIL_SSL
              valueFrom:
                secretKeyRef:
                  name: ctfd-admin-secret
                  key: MAIL_SSL
          volumeMounts:
            - name: logs
              mountPath: /var/log/CTFd
            - name: uploads
              mountPath: /var/uploads
      volumes:
        - name: logs
          persistentVolumeClaim:
            claimName: ctfd-logs-pvc
        - name: uploads
          persistentVolumeClaim:
            claimName: ctfd-uploads-pvc
---

